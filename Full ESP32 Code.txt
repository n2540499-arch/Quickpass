#include <WiFi.h>
#include <HTTPClient.h>

// WiFi
const char* ssid = "YOUR_WIFI_NAME";
const char* password = "YOUR_WIFI_PASSWORD";

// Ultrasonic 1
#define trig1 5
#define echo1 18

// Ultrasonic 2
#define trig2 4
#define echo2 19

// MQ135
#define mq135 A0

// LEDs
#define LED_EMERGENCY 12
#define LED_NORMAL 14

long readUltrasonic(int trig, int echo) {
  digitalWrite(trig, LOW); delayMicroseconds(2);
  digitalWrite(trig, HIGH); delayMicroseconds(10);
  digitalWrite(trig, LOW);
  long duration = pulseIn(echo, HIGH);
  return duration * 0.034 / 2;
}

void setup() {
  Serial.begin(115200);

  pinMode(trig1, OUTPUT);
  pinMode(echo1, INPUT);
  pinMode(trig2, OUTPUT);
  pinMode(echo2, INPUT);

  pinMode(LED_EMERGENCY, OUTPUT);
  pinMode(LED_NORMAL, OUTPUT);

  WiFi.begin(ssid, password);
  Serial.print("Connecting");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }
  Serial.println("\nConnected!");
}

void loop() {
  int d1 = readUltrasonic(trig1, echo1);
  int d2 = readUltrasonic(trig2, echo2);
  int pollution = map(analogRead(mq135), 0, 4095, 0, 100);

  String traffic = (d1 < 20 || d2 < 20) ? "Heavy Traffic" : "Clear";

  // Example control — will be connected to website later:
  // If emergency selected → LED_EMERGENCY HIGH
  // If normal selected → LED_NORMAL HIGH

  WiFiClient client;
  HTTPClient http;

  http.begin("https://your-api-url-here/data.json");

  http.addHeader("Content-Type", "application/json");

  String payload = "{\"traffic\":\"" + traffic +
                  "\",\"pollution\":" + pollution +
                  ",\"distance\":" + d1 + "}";

  http.PUT(payload);
  http.end();

  Serial.println(payload);

  delay(3000);
}
