// esp32_traffic.ino
#include <WiFi.h>
#include <HTTPClient.h>

// --- CONFIG ---
const char* WIFI_SSID = "YOUR_WIFI_SSID";
const char* WIFI_PASS = "YOUR_WIFI_PASS";
const char* BACKEND_URL = "http://YOUR_BACKEND_HOST:4000"; // e.g., http://192.168.1.50:4000 or https://yourapp.onrender.com
const char* ROAD_ID = "road-1";

// Pins (adjust as wired)
const int trig1 = 14;
const int echo1 = 27;
const int trig2 = 26;
const int echo2 = 25;
const int mqPin = 36; // ADC1_CH0
const int ledRight = 16;
const int ledLeft  = 17;

unsigned long lastSend = 0;
const unsigned long SEND_INTERVAL = 1500;
unsigned long lastPoll = 0;
const unsigned long POLL_INTERVAL = 1500;

void setup(){
  Serial.begin(115200);
  pinMode(trig1, OUTPUT); pinMode(echo1, INPUT);
  pinMode(trig2, OUTPUT); pinMode(echo2, INPUT);
  pinMode(ledRight, OUTPUT); pinMode(ledLeft, OUTPUT);
  digitalWrite(ledRight, LOW); digitalWrite(ledLeft, LOW);

  analogReadResolution(12);

  WiFi.begin(WIFI_SSID, WIFI_PASS);
  Serial.print("Connecting WiFi");
  int attempts=0;
  while(WiFi.status() != WL_CONNECTED && attempts<30){
    delay(500); Serial.print(".");
    attempts++;
  }
  Serial.println();
  if(WiFi.status()==WL_CONNECTED) Serial.println(WiFi.localIP());
  else Serial.println("WiFi failed");
}

long readUltrasonic(int trigPin, int echoPin){
  digitalWrite(trigPin, LOW); delayMicroseconds(2);
  digitalWrite(trigPin, HIGH); delayMicroseconds(10);
  digitalWrite(trigPin, LOW);
  long dur = pulseIn(echoPin, HIGH, 30000);
  if(dur==0) return 9999;
  return dur/58;
}

int readMQ(){
  int raw = analogRead(mqPin);
  return raw;
}

float mapMQpct(int raw){
  // Map raw 0..4095 -> MQ scale 100..500 -> pct
  float mqVal = map(raw, 0, 4095, 100, 500);
  if(mqVal < 100) mqVal = 100;
  if(mqVal > 500) mqVal = 500;
  return ((mqVal - 100.0) / 400.0) * 100.0;
}

void postSensor(long d1, long d2, int mqRaw){
  if(WiFi.status()!=WL_CONNECTED) return;
  HTTPClient http;
  String url = String(BACKEND_URL) + "/api/sensor/" + ROAD_ID;
  http.begin(url);
  http.addHeader("Content-Type", "application/json");

  String payload = "{";
  payload += "\"sensorId\":\"esp32-1\",";
  payload += "\"distance1\":" + String(d1) + ",";
  payload += "\"distance2\":" + String(d2) + ",";
  payload += "\"mq_raw\":" + String(mqRaw) + ",";
  payload += "\"mq_pct\":" + String(mapMQpct(mqRaw));
  payload += "}";

  int code = http.POST(payload);
  if(code > 0){
    String resp = http.getString();
    Serial.printf("POST %d : %s\n", code, resp.c_str());
  } else {
    Serial.printf("POST failed: %d\n", code);
  }
  http.end();
}

void pollLed(){
  if(WiFi.status()!=WL_CONNECTED) return;
  HTTPClient http;
  String url = String(BACKEND_URL) + "/api/led-command/" + ROAD_ID;
  http.begin(url);
  int code = http.GET();
  if(code == 200){
    String resp = http.getString();
    Serial.println("LED resp: " + resp);
    if(resp.indexOf("\"right\"")>=0){
      digitalWrite(ledRight, HIGH); digitalWrite(ledLeft, LOW);
    } else if(resp.indexOf("\"left\"")>=0){
      digitalWrite(ledLeft, HIGH); digitalWrite(ledRight, LOW);
    } else {
      digitalWrite(ledLeft, LOW); digitalWrite(ledRight, LOW);
    }
  }
  http.end();
}

void loop(){
  unsigned long now = millis();
  if(now - lastSend >= SEND_INTERVAL){
    long d1 = readUltrasonic(trig1, echo1);
    long d2 = readUltrasonic(trig2, echo2);
    int mq = readMQ();
    Serial.printf("d1=%ld d2=%ld mq=%d\n", d1, d2, mq);
    postSensor(d1,d2,mq);
    lastSend = now;
  }
  if(now - lastPoll >= POLL_INTERVAL){
    pollLed();
    lastPoll = now;
  }
  delay(10);
}

